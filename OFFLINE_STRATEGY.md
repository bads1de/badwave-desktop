# Offline-Ready Desktop Strategy (badwave-windows)

このドキュメントでは、`badwave-windows` を完全なオフライン対応デスクトップアプリケーションに進化させるための実装ロードマップをまとめます。

## 1. 方針：リモートロード型から「ローカル同梱型」への移行

現在の `mainWindow.loadURL("https://...")` 方式は便利ですが、オフライン時にアプリが起動しない弱点があります。これを解消するために、Next.js をアプリ内にビルド同梱し、データだけを API (Supabase 等) で取得する構成に変えます。

### 実装ステップ（サマリー）

1. **Next.js の「静的エクスポート」設定**: `next.config.js` を調整して `out` フォルダに全アセットを出力。
2. **Electron メインプロセスの修正**: 起動時にローカルの `index.html` を読み込むように変更。
3. **データ永続化**: `TanStack Query` のキャッシュをディスクに保存し、オフラインでも前回の情報を表示。
4. **オフライン UI 制御**: `useNetworkStatus` を活用し、接続停止時のユーザー体験を最適化。

---

## 2. 実装詳細ロードマップ

### Step 1: Next.js の静的ビルド設定

`next.config.js` を修正し、サーバーサイド機能を排したビルドを行うようにします。

- [ ] `output: 'export'` の追加
- [ ] `images: { unoptimized: true }` の設定（静的ビルドでは Next.js の画像最適化が動かないため）

### Step 2: Electron メインプロセスの修正 (`main.ts`)

`electron-serve` 等を利用して、ローカルの `out` フォルダからファイルを配信します。

- [ ] 本番環境の `loadURL` を `app://./index.html` または `file://` に変更。
- [ ] オフライン時でも、最初にローカルの HTML が表示されることを確認。

### Step 3: TanStack Query の永続化 (Persist)

アプリを閉じても、前回オンライン時に取得したリスト（トレンド曲など）を表示できるようにします。

- [ ] `@tanstack/query-sync-storage-persister` の導入。
- [ ] `localStorage` を保存先として設定し、オフライン起動時にキャッシュからデータを復元。

### Step 4: ファイル・プロトコルの最適化

現在実装済みの `registerAppProtocol` (`app://`) を活用し、ローカルの MP3 ファイルをオフライン環境でも確実に再生できるように維持・検証します。

- [ ] ダウンロード済みの曲と、スキャン済みのローカル曲のパス解決がオフラインでも機能することを確認。

### Step 5: Web 版との切り分け (Middleware 等)

静的エクスポートでは Next.js の `middleware.ts` が使えなくなります。

- [ ] 認証チェック（リダイレクト）などを `layout.tsx` などのクライアントサイドで行うように調整。

---

## 3. 実現後のユーザー体験

| 状態                      | アプリの挙動                                                                                                                  |
| :------------------------ | :---------------------------------------------------------------------------------------------------------------------------- |
| **起動時 (オフライン)**   | 即座にサイドバーと前回のホームリストがロードされる。「オフラインです」のバナーが表示され、ローカル/キャッシュ曲が即再生可能。 |
| **音楽再生 (オフライン)** | ディスクにある MP3 が `app://` プロトコル経由でそのまま再生される。                                                           |
| **起動時 (オンライン)**   | 最新のトレンドやプレイリストがバックグラウンドでフェッチされ、最新状態に更新される。                                          |
| **曲の管理**              | オフラインでも、スキャン済みの音楽ファイルは常にリストに表示され、メタデータも利用可能。                                      |

---

## 4. 便利な参考ツール

- [Nextron](https://github.com/saltyshiomix/nextron) (Next.js + Electron のビルド構成の参考)
- [TanStack Query Sync Storage Persister](https://tanstack.com/query/v4/docs/react/plugins/persistQueryClient)
